<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bingo M√°gico - Venta de Cartones</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0b021a 0%, #121212 100%);
      color: #f0f0f0; font-family: 'Nunito', sans-serif;
      margin: 0; padding: 20px; min-height: 100vh;
    }
    .header { display: flex; flex-direction: column; align-items: center; position: relative; gap: 10px; margin-bottom: 30px; }
    .logo-mago { font-size: 50px; } 
    h1 { color: #ffffff; text-shadow: 0 0 15px rgba(255,255,255,0.4); font-size: 2.2em; margin: 0; }
    .registro-nav-btn { background-color: #37474F; color: #fdd835; border: 1px solid #fdd835; padding: 8px 16px; border-radius: 8px; font-weight: 900; cursor: pointer; }
    form { max-width: 600px; margin: 0 auto 30px auto; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px; border: 1px solid #333; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #fdd835; }
    input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #444; background: #1e1e1e; color: #fff; font-weight: 900; font-size: 1.2em; }
    input#monto { background-color: #000; color: #fdd835; text-align: center; font-size: 1.8em; border-color: #fdd835; }
    button[type="submit"] { margin-top: 25px; width: 100%; padding: 18px; background: linear-gradient(45deg, #fdd835, #fbc02d); border: none; border-radius: 10px; font-weight: 900; font-size: 1.4em; cursor: pointer; }
    #copyImageBtn { max-width: 600px; display: block; margin: 15px auto; background: linear-gradient(45deg, #00c853, #64dd17); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: 900; width: 100%; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
    .tabla-scroll { width: 100%; overflow-x: auto; margin-top: 30px; padding-bottom: 15px; }
    #panel-cartones { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; background-color: #ffffff; padding: 10px; border-radius: 10px; min-width: 1400px; margin: 0 auto; }
    .carton-btn { aspect-ratio: 1/1; background: #fff; border: 1px solid #eee; color: #000; font-weight: 900; font-size: 2.2em; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .carton-btn.selected { background-color: #fdd835; border-color: #000; transform: scale(1.1); z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
    .carton-btn.vendido { opacity: 0.03; pointer-events: none; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJXV1uIO7k-mskXmLeTLRzH0JmBW6Bkm4",
      authDomain: "bingomagic.firebaseapp.com",
      projectId: "bingomagic",
      storageBucket: "bingomagic.firebasestorage.app",
      messagingSenderId: "239927101364",
      appId: "1:239927101364:web:7557e068b2564c63a194e1",
      measurementId: "G-0GJL6DJCEB"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>

<div class="header">
  <div class="logo-mago">üßô‚Äç‚ôÄÔ∏è</div> 
  <h1>‚ú® BINGO MAGIC SORA (530)</h1>
  <button class="registro-nav-btn" onclick="window.location.href='registro.html'">Ver Registros</button>
</div>

<form id="compraForm">

  <label>Nombre del Jugador:</label>
  <input type="text" id="nombre" required placeholder="Nombre del cliente" />

  <label>Cartones (Escribe 22-23, 22/23, 22 23 o pega lista):</label>
  <input type="text" id="cartonesSeleccionados" placeholder="Cualquier separador funciona" autocomplete="off" />

  <div id="alertaNoDisponibles" style="margin-top:10px; font-size:1.1em;"></div>

  <button id="copiarNoDisponiblesBtn" type="button"
    style="margin-top:10px; width:100%; padding:12px; border:none; border-radius:10px;
    background:#e53935; color:white; font-weight:900; cursor:pointer; display:none;">
    Copiar No Disponibles
  </button>

  <!-- üî• BOT√ìN AZAR SEGURO -->
  <button id="azarBtn" type="button"
    style="margin-top:10px; width:100%; padding:12px; border:none; border-radius:10px;
    background:#2196F3; color:white; font-weight:900; cursor:pointer;">
    +1 AZAR
  </button>

  <label>Cartones Pendientes:</label>
  <input type="number" id="pendientes" value="0" min="0" />

  <label>Referencia de Pago:</label>
  <input type="text" id="referencia" required maxlength="6" placeholder="6 d√≠gitos" />

  <label>Monto Total (Bs):</label>
  <input type="text" id="monto" readonly value="0" />

  <button type="submit" id="comprarBtn">REGISTRAR COMPRA</button>
</form>

<button id="copyImageBtn">üì∏ COPIAR TABLA + TEXTO PARA WHATSAPP</button>

<div class="tabla-scroll">
  <div id="panel-cartones"></div>
</div>

<script>
  const TOTAL_CARTONES = 510;
  const PRECIO_CARTON = 100;
  const panel = document.getElementById('panel-cartones');
  const seleccionadosInput = document.getElementById('cartonesSeleccionados');
  const montoInput = document.getElementById('monto');
  const pendientesInput = document.getElementById('pendientes');
  const refInput = document.getElementById("referencia");

  let seleccionados = new Set();
  let vendidos = new Set();

  // üî• BLOQUEAR ENTER
  document.querySelectorAll("input").forEach(input => {
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") e.preventDefault();
    });
  });

  // üî• VALIDAR REFERENCIA (solo 6 n√∫meros)
  refInput.addEventListener("input", () => {
    refInput.value = refInput.value.replace(/\D/g, "").slice(0, 6);
  });

  // üî• BLOQUEAR SUBMIT ACCIDENTAL DESDE AZAR
  document.getElementById("azarBtn").addEventListener("click", e => {
    e.preventDefault();
    e.stopPropagation();
  });

  async function cargarVendidos() {
    db.collection('registrosCartones').onSnapshot(snap => {
      vendidos.clear();
      snap.forEach(doc => vendidos.add(parseInt(doc.id)));
      actualizarVisualTablero();
    });
  }

  function actualizarVisualTablero() {
    document.querySelectorAll('.carton-btn').forEach(btn => {
      const n = parseInt(btn.dataset.numero);
      btn.classList.toggle('vendido', vendidos.has(n));
      btn.classList.toggle('selected', seleccionados.has(n));
    });
  }

  // Generar Tablero
  for (let i = 1; i <= TOTAL_CARTONES; i++) {
    const btn = document.createElement('button');
    btn.className = 'carton-btn';
    btn.textContent = i;
    btn.dataset.numero = i;
    btn.type = "button";
    btn.onclick = () => {
      if (vendidos.has(i)) return;
      if (seleccionados.has(i)) seleccionados.delete(i);
      else seleccionados.add(i);
      actualizarInputDesdeSeleccion();
    };
    panel.appendChild(btn);
  }

  function actualizarInputDesdeSeleccion() {
    seleccionadosInput.value = Array.from(seleccionados).sort((a,b)=>a-b).join(', ');
    actualizarVisualTablero();
    actualizarTotales();
  }

  // --- NO DISPONIBLES ---
  const alertaNoDisponibles = document.getElementById('alertaNoDisponibles');
  const copiarNoDisponiblesBtn = document.getElementById('copiarNoDisponiblesBtn');

  seleccionadosInput.oninput = function() {
    const nums = this.value.match(/\d+/g) || [];
    const nuevoSeleccionados = new Set();
    const noDisponibles = [];

    nums.forEach(str => {
      const n = parseInt(str);
      if (n >= 1 && n <= TOTAL_CARTONES) {
        if (!vendidos.has(n)) nuevoSeleccionados.add(n);
        else noDisponibles.push(n);
      }
    });

    seleccionados = nuevoSeleccionados;
    this.value = Array.from(seleccionados).sort((a,b)=>a-b).join(', ');

    actualizarVisualTablero();
    actualizarTotales();

    if (noDisponibles.length > 0) {
      alertaNoDisponibles.innerHTML = `
        <div style="color:#ff5252;">
          No disponibles: <b>${noDisponibles.join(", ")}</b>
        </div>
      `;
      copiarNoDisponiblesBtn.style.display = "block";

      copiarNoDisponiblesBtn.onclick = () => {
        navigator.clipboard.writeText("No disponibles: " + noDisponibles.join(", "));
        alert("Copiado al portapapeles");
      };

    } else {
      alertaNoDisponibles.innerHTML = "";
      copiarNoDisponiblesBtn.style.display = "none";
    }
  };

  // --- üî• BOT√ìN AZAR ---
  document.getElementById("azarBtn").onclick = () => {

    const disponibles = [];
    for (let i = 1; i <= TOTAL_CARTONES; i++) {
      if (!vendidos.has(i) && !seleccionados.has(i)) {
        disponibles.push(i);
      }
    }

    if (disponibles.length === 0) {
      alert("No quedan cartones disponibles.");
      return;
    }

    const random = disponibles[Math.floor(Math.random() * disponibles.length)];

    seleccionados.add(random);
    actualizarInputDesdeSeleccion();
  };

  function actualizarTotales() {
    const p = parseInt(pendientesInput.value) || 0;
    montoInput.value = (seleccionados.size + p) * PRECIO_CARTON;
  }
  pendientesInput.oninput = actualizarTotales;

  // --- üî• REGISTRAR COMPRA ---
  document.getElementById('compraForm').onsubmit = async e => {
    e.preventDefault();

    const btn = document.getElementById('comprarBtn');
    btn.disabled = true;

    // Validar referencia
    if (refInput.value.length !== 6) {
      alert("La referencia debe tener exactamente 6 n√∫meros.");
      btn.disabled = false;
      return;
    }

    try {
      const batch = db.batch();
      const nombre = document.getElementById('nombre').value;

      seleccionados.forEach(n => batch.set(db.collection('registrosCartones').doc(n.toString()), { nombre }));

      batch.set(db.collection('registrosPagos').doc(), {
        nombre,
        monto: montoInput.value,
        referencia: refInput.value,
        cartones: Array.from(seleccionados),
        pendientes: parseInt(pendientesInput.value) || 0,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      await batch.commit();
      location.reload();

    } catch (err) {
      alert("Error");
      btn.disabled = false;
    }
  };

  cargarVendidos();
</script>
</body>
</html>


