<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bingo M√°gico - SORA MAGIC</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@900&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0b021a 0%, #121212 100%);
      color: #f0f0f0; font-family: 'Nunito', sans-serif;
      margin: 0; padding: 20px; min-height: 100vh;
    }
    .header { display: flex; flex-direction: column; align-items: center; position: relative; gap: 10px; margin-bottom: 30px; }
    .logo-mago { font-size: 50px; } 
    h1 { color: #ffffff; text-shadow: 0 0 15px rgba(255,255,255,0.4); font-size: 2.2em; margin: 0; }
    .registro-nav-btn { background-color: #37474F; color: #fdd835; border: 1px solid #fdd835; padding: 8px 16px; border-radius: 8px; font-weight: 900; cursor: pointer; }
    form { max-width: 600px; margin: 0 auto 30px auto; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px; border: 1px solid #333; }
    label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #fdd835; }
    input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #444; background: #1e1e1e; color: #fff; font-weight: 900; font-size: 1.2em; }
    input#monto { background-color: #000; color: #fdd835; text-align: center; font-size: 1.8em; border-color: #fdd835; }
    button[type="submit"] { margin-top: 25px; width: 100%; padding: 18px; background: linear-gradient(45deg, #fdd835, #fbc02d); border: none; border-radius: 10px; font-weight: 900; font-size: 1.4em; cursor: pointer; }
    #copyImageBtn { max-width: 600px; display: block; margin: 15px auto; background: linear-gradient(45deg, #00c853, #64dd17); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: 900; width: 100%; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
    .tabla-scroll { width: 100%; overflow-x: auto; margin-top: 30px; padding-bottom: 15px; }
    #panel-cartones { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; background-color: #ffffff; padding: 10px; border-radius: 10px; min-width: 1400px; margin: 0 auto; }
    .carton-btn { aspect-ratio: 1/1; background: #fff; border: 1px solid #eee; color: #000; font-weight: 900; font-size: 2.2em; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .carton-btn.selected { background-color: #fdd835; border-color: #000; transform: scale(1.1); z-index: 5; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
    .carton-btn.vendido { opacity: 0.03; pointer-events: none; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCJXV1uIO7k-mskXmLeTLRzH0JmBW6Bkm4",
      authDomain: "bingomagic.firebaseapp.com",
      projectId: "bingomagic",
      storageBucket: "bingomagic.firebasestorage.app",
      messagingSenderId: "239927101364",
      appId: "1:239927101364:web:7557e068b2564c63a194e1",
      measurementId: "G-0GJL6DJCEB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>
<body>

<div class="header">
  <div class="logo-mago">üßô‚Äç‚ôÇÔ∏è</div> 
  <h1>‚ú® ¬°¬°¬°BINGO MAGIC NIGHT!!! (630)</h1>
  <button class="registro-nav-btn" onclick="window.location.href='registro.html'">Ver Registros</button>
</div>

<form id="compraForm">
  <label>Nombre del Jugador:</label>
  <input type="text" id="nombre" required placeholder="Nombre del cliente" />

  <label>Cartones (Escribe 22-23, 22/23, 22 23 o pega lista):</label>
  <input type="text" id="cartonesSeleccionados" placeholder="Cualquier separador funciona" autocomplete="off" />

  <label>Cartones Pendientes:</label>
  <input type="number" id="pendientes" value="0" min="0" />

  <label>Referencia de Pago:</label>
  <input type="text" id="referencia" required />

  <label>Monto Total (Bs):</label>
  <input type="text" id="monto" readonly value="0" />

  <button type="submit" id="comprarBtn">REGISTRAR COMPRA</button>
</form>

<button id="copyImageBtn">üì∏ COPIAR TABLA PARA WHATSAPP</button>

<div class="tabla-scroll">
  <div id="panel-cartones"></div>
</div>

<script>
  const TOTAL_CARTONES = 500;
  const PRECIO_CARTON = 100;
  const panel = document.getElementById('panel-cartones');
  const seleccionadosInput = document.getElementById('cartonesSeleccionados');
  const montoInput = document.getElementById('monto');
  const pendientesInput = document.getElementById('pendientes');

  let seleccionados = new Set();
  let vendidos = new Set();

  async function cargarVendidos() {
    db.collection('registrosCartones').onSnapshot(snap => {
      vendidos.clear();
      snap.forEach(doc => vendidos.add(parseInt(doc.id)));
      actualizarVisualTablero();
    });
  }

  function actualizarVisualTablero() {
    document.querySelectorAll('.carton-btn').forEach(btn => {
      const n = parseInt(btn.dataset.numero);
      btn.classList.toggle('vendido', vendidos.has(n));
      btn.classList.toggle('selected', seleccionados.has(n));
    });
  }

  for (let i = 1; i <= TOTAL_CARTONES; i++) {
    const btn = document.createElement('button');
    btn.className = 'carton-btn';
    btn.textContent = i;
    btn.dataset.numero = i;
    btn.onclick = () => {
      if (vendidos.has(i)) return;
      if (seleccionados.has(i)) seleccionados.delete(i);
      else seleccionados.add(i);
      actualizarInputDesdeSeleccion();
    };
    panel.appendChild(btn);
  }

  function actualizarInputDesdeSeleccion() {
    seleccionadosInput.value = Array.from(seleccionados).sort((a,b)=>a-b).join(', ');
    actualizarVisualTablero();
    actualizarTotales();
  }

  seleccionadosInput.oninput = function() {
    const nums = this.value.match(/\d+/g) || [];
    const nuevoSeleccionados = new Set();

    nums.forEach(str => {
      const n = parseInt(str);
      if (n >= 1 && n <= TOTAL_CARTONES && !vendidos.has(n)) {
        nuevoSeleccionados.add(n);
      }
    });

    seleccionados = nuevoSeleccionados;
    this.value = Array.from(seleccionados).sort((a,b)=>a-b).join(', ');

    actualizarVisualTablero();
    actualizarTotales();
  };

  function actualizarTotales() {
    const p = parseInt(pendientesInput.value) || 0;
    montoInput.value = (seleccionados.size + p) * PRECIO_CARTON;
  }
  pendientesInput.oninput = actualizarTotales;

  // --- COPIAR SOLO LA IMAGEN ---
  document.getElementById('copyImageBtn').onclick = async () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const cols = 20;
    const rows = Math.ceil(TOTAL_CARTONES / cols);
    const cellSize = 75;
    const pad = 5;

    canvas.width = cols * (cellSize + pad) + pad;
    canvas.height = 100 + rows * (cellSize + pad) + pad;

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = '#000';
    ctx.font = 'bold 35px Nunito';
    ctx.textAlign = 'center';
    ctx.fillText('CARTONES DISPONIBLES', canvas.width / 2, 60);

    for (let i = 1; i <= TOTAL_CARTONES; i++) {
      if (vendidos.has(i)) continue;

      const col = (i - 1) % cols;
      const row = Math.floor((i - 1) / cols);
      const x = col * (cellSize + pad) + pad;
      const y = 100 + row * (cellSize + pad) + pad;

      ctx.strokeStyle = '#eee';
      ctx.strokeRect(x, y, cellSize, cellSize);

      ctx.fillStyle = '#000';
      ctx.font = '900 28px Nunito';
      ctx.textBaseline = 'middle';
      ctx.fillText(i.toString(), x + cellSize / 2, y + cellSize / 2);
    }

    canvas.toBlob(async blob => {
      try {
        await navigator.clipboard.write([
          new ClipboardItem({ "image/png": blob })
        ]);

        alert("üì∏ Imagen copiada al portapapeles.");
      } catch (e) {
        alert("‚ùå Error al copiar. Usa HTTPS y Chrome.");
        console.error(e);
      }
    });
  };

  document.getElementById('compraForm').onsubmit = async e => {
    e.preventDefault();
    const btn = document.getElementById('comprarBtn');
    btn.disabled = true;
    try {
      const batch = db.batch();
      const nombre = document.getElementById('nombre').value;
      seleccionados.forEach(n => batch.set(db.collection('registrosCartones').doc(n.toString()), { nombre }));
      batch.set(db.collection('registrosPagos').doc(), {
        nombre, monto: montoInput.value, referencia: document.getElementById('referencia').value,
        cartones: Array.from(seleccionados), pendientes: parseInt(pendientesInput.value) || 0,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      await batch.commit();
      location.reload();
    } catch (err) { alert("Error"); btn.disabled = false; }
  };

  cargarVendidos();
</script>
</body>
</html>
