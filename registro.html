<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registro de Compras (0.4 - Separación de Pagos)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  * {
      box-sizing: border-box;
  }
  
  body { 
      background: linear-gradient(135deg, #0b021a 0%, #121212 100%); 
      color: #f0f0f0; 
      font-family: 'Nunito', Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      min-height: 100vh;
  }

  .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
  }

  header { 
      display: flex; 
      justify-content: space-between;
      align-items: center; 
      gap: 20px; 
      margin-bottom: 30px; 
      border-bottom: 1px solid #333;
      padding-bottom: 20px;
  }
  
  h1, h2 { 
      margin: 0; 
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
  }

  h2 {
      margin-top: 40px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.8em;
  }

  /* --- Barra de Botones Principal --- */
  .button-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
  }
  
  /* --- Estilo de Botones Moderno --- */
  button.volver-btn, button.borrar-btn, button.gestion-btn, button.copiar-btn {
      border: none; 
      color: white; 
      font-weight: bold;
      padding: 10px 20px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 1em;
      font-family: 'Nunito', Arial, sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  
  button.volver-btn, button.gestion-btn {
      background-color: #37474F;
  }
  button.volver-btn:hover, button.gestion-btn:hover { 
      background-color: #546E7A;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }
  
  /* Botón Copiar: Verde para destacar */
  button.copiar-btn {
      background: linear-gradient(45deg, #4CAF50, #8BC34A); 
      color: white; 
      font-size: 1.05em; 
      padding: 12px 22px;
  }
  button.copiar-btn:hover {
      background: linear-gradient(45deg, #8BC34A, #689F38);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
  }

  button.borrar-btn { 
      background-color: #e53935;
  }
  button.borrar-btn:hover { 
      background-color: #c62828;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229, 57, 53, 0.3);
  }
  
  /* --- Panel de Resumen --- */
  .resumen { 
      text-align: center; 
      margin-bottom: 40px; 
      font-size: 1.1em;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #333;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px 25px;
  }
  .resumen span { 
      display: inline-block; 
      margin: 0;
  }
  /* Resaltar números en dorado (total) y azul (apartados) */
  .resumen b {
      color: #fdd835;
  }
  .resumen b.apartado-count {
      color: #2196f3; /* Azul para apartados */
  }


  /* --- Estilo de Tablas Moderno --- */
  table { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 40px; 
      background: #1e1e1e;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #333;
  }
  
  /* Estilo especial para la tabla de Apartados */
  #tablaApartados {
    border: 1px solid #2196f3; /* Borde azul para destacar */
  }
  #tablaApartados caption {
    background: #1A237E; /* Azul oscuro */
  }

  caption { 
      font-weight: 700; 
      font-size: 1.3em; 
      padding: 15px; 
      background: #2a2a2a;
      color: #f0f0f0;
      text-align: left;
  }
  
  th, td { 
      border: none;
      border-bottom: 1px solid #333; 
      padding: 12px 15px; 
      text-align: left; 
      color: #ccc;
  }
  th { 
      background: #252525; 
      color: #fff;
      font-weight: 700;
  }
  
  /* Quita el borde de la última fila */
  tbody tr:last-child td {
      border-bottom: none;
  }

  .referencia-duplicada { 
      color: #ff6b6b;
      font-weight: 700; 
  }
  .referencia-duplicada::after { 
      content: '  ¡Duplicada!'; 
      font-size: 0.85em; 
  }
  
  .carton-pendiente {
      color: #fdd835;
      font-weight: 700;
      margin-left: 8px;
  }

  /* --- Panel de Gestión y Botones de Acción --- */
  #gestionPanel { 
      display: none; 
      background: #1e1e1e; 
      padding: 20px; 
      border-radius: 12px; 
      max-height: 500px; 
      overflow-y: auto; 
      margin-bottom: 30px; 
      border: 1px solid #333;
  }
  #gestionPanel h2 { 
      margin-top: 0; 
      margin-bottom: 20px; 
      text-align: left;
  }
  #gestionPanel table { 
      margin-bottom: 0; 
      border: none;
  }
  
  /* Botones de acción en tablas */
  #gestionPanel button.edit-btn, #gestionPanel button.delete-btn,
  #tablaPagos button.edit-btn, #tablaPagos button.delete-btn,
  #tablaApartados button.edit-btn, #tablaApartados button.delete-btn { /* Agregado #tablaApartados */
      padding: 4px 10px; 
      margin: 2px 3px; 
      font-size: 0.9em; 
      cursor: pointer; 
      border-radius: 4px; 
      border: none;
      font-weight: 700;
      font-family: 'Nunito', Arial, sans-serif;
      transition: all 0.2s ease;
  }
  
  button.edit-btn { background: #2196f3; color: white; }
  button.edit-btn:hover { background: #0b7dda; transform: scale(1.05); }
  button.delete-btn { background: #e53935; color: white; }
  button.delete-btn:hover { background: #c62828; transform: scale(1.05); }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Tu configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCJXV1uIO7k-mskXmLeTLRzH0JmBW6Bkm4",
    authDomain: "bingomagic.firebaseapp.com",
    projectId: "bingomagic",
    storageBucket: "bingomagic.firebasestorage.app",
    messagingSenderId: "239927101364",
    appId: "1:239927101364:web:7557e068b2564c63a194e1",
    measurementId: "G-0GJL6DJCEB"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Función auxiliar para determinar si la referencia es un 'Apartado' (no numérica)
  function esReferenciaNumerica(referencia) {
      if (!referencia) return false;
      // Una referencia es numérica si es un número válido. 
      // Si contiene alguna letra, es falso.
      return /^\d+$/.test(referencia.trim());
  }

  // Función principal para cargar y renderizar registros
  async function cargarRegistros() {
    const registros = {};
    let totalMonto = 0;
    const referencias = new Map();
    let totalPendientes = 0; 
    let totalApartados = 0; // Nuevo contador

    // Cargar registrosCartones
    const snapshotCartones = await db.collection('registrosCartones').get();
    snapshotCartones.forEach(doc => { registros[doc.id] = doc.data().nombre; });

    const cartonesOrdenados = Object.keys(registros).map(Number).sort((a,b) => a-b);
    const tbodyCartones = document.querySelector('#tablaCartones tbody');
    tbodyCartones.innerHTML = '';
    for (const c of cartonesOrdenados) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c}</td><td>${registros[c]}</td>`;
      tbodyCartones.appendChild(tr);
    }

    // Cargar registrosPagos
    const snapshotPagos = await db.collection('registrosPagos').orderBy('timestamp', 'desc').get();
    const tbodyPagos = document.querySelector('#tablaPagos tbody');
    const tbodyApartados = document.querySelector('#tablaApartados tbody'); // Nuevo tbody
    
    tbodyPagos.innerHTML = '';
    tbodyApartados.innerHTML = '';

    snapshotPagos.forEach(doc => {
      const data = doc.data();
      const refEsNumerica = esReferenciaNumerica(data.referencia);
      
      if (!refEsNumerica) {
          totalApartados++; // Contar solo si es un apartado
      }

      totalMonto += parseFloat(data.monto);

      const referenciaDuplicada = referencias.has(data.referencia);
      referencias.set(data.referencia, true);
      
      const cartonesStr = (data.cartones && data.cartones.length > 0) ? data.cartones.join(", ") : "";
      const numPendientes = data.pendientes || 0;
      totalPendientes += numPendientes; 
      
      const pendienteStr = (numPendientes > 0) ? `<span class="carton-pendiente">(+${numPendientes} pendiente${numPendientes > 1 ? 's' : ''})</span>` : "";
      
      let celdaCartones = cartonesStr + pendienteStr;
      if (celdaCartones.trim() === "") { 
          celdaCartones = "-"; 
      }

      const tr = document.createElement('tr');
      
      // Lógica de Renderizado: Pago Directo o Apartado
      if (refEsNumerica) {
          // PAGO DIRECTO (Referencia numérica)
          tr.innerHTML = `
            <td>${data.monto}</td>
            <td class="${referenciaDuplicada ? 'referencia-duplicada' : ''}">${data.referencia}</td>
            <td>${data.nombre || "-"}</td>
            <td>${celdaCartones}</td>
            <td>
              <button class='edit-btn' onclick='editarPago("${doc.id}", ${JSON.stringify(data.cartones || [])}, ${numPendientes})'>Editar</button>
              <button class='delete-btn' onclick='eliminarPago("${doc.id}", ${JSON.stringify(data.cartones || [])})'>Eliminar</button>
            </td>
          `;
          tbodyPagos.appendChild(tr);
      } else {
          // APARTADO (Referencia con letras)
          tr.innerHTML = `
            <td>${data.monto}</td>
            <td class="${referenciaDuplicada ? 'referencia-duplicada' : ''}">${data.referencia}</td>
            <td>${data.nombre || "-"}</td>
            <td>${celdaCartones}</td>
            <td>
              <button class='edit-btn' onclick='editarApartadoReferencia("${doc.id}", "${data.referencia}")'>Editar Ref.</button>
              <button class='edit-btn' onclick='editarPago("${doc.id}", ${JSON.stringify(data.cartones || [])}, ${numPendientes})'>Editar Cartones</button>
              <button class='delete-btn' onclick='eliminarPago("${doc.id}", ${JSON.stringify(data.cartones || [])})'>Eliminar</button>
            </td>
          `;
          tbodyApartados.appendChild(tr);
      }
    });

    // Actualizar Resumen
    document.getElementById('resumen').innerHTML = `
      <span>Cartones vendidos: <b>${cartonesOrdenados.length}</b></span>
      <span>Cartones faltantes: <b>${360 - cartonesOrdenados.length}</b></span>
      ${totalPendientes > 0 ? `<span>Pendientes por asignar: <b>${totalPendientes}</b></span>` : ''}
      ${totalApartados > 0 ? `<span>Apartados pendientes: <b class="apartado-count">${totalApartados}</b></span>` : ''}
      <span>
        Monto total registrado: <b>${totalMonto} Bs</b>
        ${totalMonto !== (cartonesOrdenados.length + totalPendientes) * 75 
          ? ' <b style="color:#ff6b6b;">⚠ Inconsistencia</b>' 
          : ''}
      </span>
    `;

    if (document.getElementById('gestionPanel').style.display === 'block') {
      cargarGestionPanel(registros, cartonesOrdenados);
    }
  }

  // ** NUEVA FUNCIÓN: Editar Referencia del Apartado **
  async function editarApartadoReferencia(pagoId, referenciaActual) {
      const nuevaReferencia = prompt(`Editar la referencia para el apartado "${referenciaActual}":`, referenciaActual);
      
      if (nuevaReferencia && nuevaReferencia.trim()) {
          const referenciaLimpia = nuevaReferencia.trim();
          
          // Opcional: Podrías añadir lógica aquí para verificar si la nueva referencia ya existe.
          
          try {
              await db.collection('registrosPagos').doc(pagoId).update({
                  referencia: referenciaLimpia
              });
              alert(`Referencia actualizada a: ${referenciaLimpia}.`);
              cargarRegistros();
          } catch (error) {
              console.error("Error al actualizar la referencia:", error);
              alert("Error al actualizar la referencia del apartado.");
          }
      }
  }


  // Las demás funciones (toggleGestion, cargarGestionPanel, editarNombre, eliminarCarton, editarPago, eliminarPago, borrarRegistros, copiarTablasAlPortapapeles) 
  // quedan sin cambios respecto a tu última versión, solo se asegura la referencia a la nueva tabla en copiar.

  function toggleGestion() {
    const panel = document.getElementById('gestionPanel');
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    if (panel.style.display === 'block') cargarRegistros();
  }

  function cargarGestionPanel(registros, cartonesOrdenados) {
    const tbodyGestion = document.querySelector('#gestionTabla tbody');
    tbodyGestion.innerHTML = '';
    cartonesOrdenados.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c}</td><td>${registros[c]}</td><td>
        <button class='edit-btn' onclick='editarNombre(${c})'>Editar</button>
        <button class='delete-btn' onclick='eliminarCarton(${c})'>Eliminar</button>
      </td>`;
      tbodyGestion.appendChild(tr);
    });
  }

  function editarNombre(carton) {
    const nuevoNombre = prompt("Editar nombre del jugador para cartón " + carton + ":");
    if (nuevoNombre && nuevoNombre.trim()) {
      db.collection('registrosCartones').doc(carton.toString()).update({ nombre: nuevoNombre.trim() })
        .then(() => cargarRegistros());
    }
  }

  function eliminarCarton(carton) {
    if (confirm("¿Deseas eliminar el cartón " + carton + " del registro?")) {
      db.collection('registrosCartones').doc(carton.toString()).delete().then(() => cargarRegistros());
    }
  }

  async function editarPago(pagoId, cartonesActuales, pendientesActuales) {
    const pagoDoc = await db.collection('registrosPagos').doc(pagoId).get();
    const data = pagoDoc.data();

    // Si es un apartado, no permitimos editar cartones hasta que se ponga una referencia numérica.
    if (!esReferenciaNumerica(data.referencia)) {
        alert("Este es un Apartado. Por favor, edita primero la Referencia si el pago ya fue confirmado.");
        return;
    }

    const nuevoTexto = prompt("Edita los cartones comprados (separados por coma):", cartonesActuales.join(", "));
    if (nuevoTexto === null) return; 

    const nuevoPendienteTexto = prompt("Edita el número de cartones PENDIENTES:", pendientesActuales);
    if (nuevoPendienteTexto === null) return; 

    const nuevosCartones = nuevoTexto.split(",").map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 360);
    const nuevosPendientes = parseInt(nuevoPendienteTexto) || 0;

    const snapshot = await db.collection('registrosCartones').get();
    const vendidos = new Set();
    snapshot.forEach(doc => vendidos.add(parseInt(doc.id)));

    for (let n of nuevosCartones) {
      if (vendidos.has(n) && !cartonesActuales.includes(n)) {
        alert(`El cartón ${n} ya está vendido.`);
        return;
      }
    }

    const batch = db.batch();

    cartonesActuales.forEach(n => {
      if (!nuevosCartones.includes(n)) {
        batch.delete(db.collection('registrosCartones').doc(n.toString()));
      }
    });

    nuevosCartones.forEach(n => {
      if (!cartonesActuales.includes(n)) {
          batch.set(db.collection('registrosCartones').doc(n.toString()), { nombre: data.nombre });
      }
    });

    batch.update(db.collection('registrosPagos').doc(pagoId), { 
        cartones: nuevosCartones,
        pendientes: nuevosPendientes
    });

    await batch.commit();
    alert("Pago actualizado correctamente.");
    cargarRegistros();
  }

  async function eliminarPago(pagoId, cartones) {
    if (!confirm("¿Deseas eliminar este pago y liberar los cartones?")) return;
    try {
      const batch = db.batch();
      // Eliminar cartones asociados
      cartones.forEach(n => {
        batch.delete(db.collection('registrosCartones').doc(n.toString()));
      });
      // Eliminar pago
      batch.delete(db.collection('registrosPagos').doc(pagoId));
      await batch.commit();
      alert("Pago eliminado correctamente.");
      cargarRegistros();
    } catch (error) {
      console.error("Error eliminando pago:", error);
      alert("Error al eliminar el pago.");
    }
  }

  async function borrarRegistros() {
    if (!confirm("¿Estás seguro que quieres borrar todos los registros?")) return;
    try {
      const batch = db.batch();
      const cartonesSnapshot = await db.collection('registrosCartones').get();
      cartonesSnapshot.forEach(doc => batch.delete(doc.ref));
      const pagosSnapshot = await db.collection('registrosPagos').get();
      pagosSnapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      alert("Todos los registros han sido borrados.");
      cargarRegistros();
    } catch (error) {
      console.error("Error borrando registros:", error);
      alert("Error al borrar los registros.");
    }
  }

  function copiarTablasAlPortapapeles() {
    function tablaAtexto(tabla) {
      let texto = '';
      
      const theads = tabla.querySelector('thead');
      if (theads) {
        const headerCeldas = theads.querySelectorAll('th');
        const headerTexto = Array.from(headerCeldas)
          .filter(c => c.textContent.trim() !== 'Acciones')
          .map(c => c.textContent.trim())
          .join('\t');
        if (headerTexto) texto += headerTexto + '\n';
      }

      const tbody = tabla.querySelector('tbody');
      if (tbody) {
        const bodyFilas = tbody.querySelectorAll('tr');
        bodyFilas.forEach(fila => {
          const celdas = fila.querySelectorAll('td');
          
          // El -2 se usa porque la tabla de Apartados tiene 5 columnas de datos + 1 de Acciones = 6.
          // La tabla de Pagos tiene 4 columnas de datos + 1 de Acciones = 5.
          // Aquí necesitamos filtrar la última columna si contiene botones.
          const filaTexto = Array.from(celdas)
            .filter((c, idx) => !fila.querySelector('button') || idx < celdas.length - 1)
            .map(c => c.textContent.trim().replace(/\s+/g, ' '))
            .join('\t');
          
          if (filaTexto) texto += filaTexto + '\n';
        });
      }
      return texto;
    }
    
    const tablaCartones = document.getElementById('tablaCartones');
    const tablaPagos = document.getElementById('tablaPagos');
    const tablaApartados = document.getElementById('tablaApartados');

    const textoCartones = tablaAtexto(tablaCartones);
    const textoPagos = tablaAtexto(tablaPagos);
    const textoApartados = tablaAtexto(tablaApartados);

    let textoFinal = `== CARTONES VENDIDOS ==\n${textoCartones}\n\n`;
    textoFinal += `== REGISTRO DE PAGOS (Directos) ==\n${textoPagos}\n\n`;
    textoFinal += `== REGISTRO DE APARTADOS ==\n${textoApartados}`;

    navigator.clipboard.writeText(textoFinal)
      .then(() => alert('¡Todas las tablas (Cartones, Pagos y Apartados) copiadas al portapapeles!'))
      .catch(err => alert('Error al copiar: ' + err));
  }
  
  // Inicialización
  document.addEventListener('DOMContentLoaded', () => {
    cargarRegistros();
    document.getElementById('btnBorrar').addEventListener('click', borrarRegistros);
    document.getElementById('btnGestion').addEventListener('click', toggleGestion);
    document.getElementById('btnCopiar').addEventListener('click', copiarTablasAlPortapapeles);
  });
</script>
</head>
<body>

<div class="content-wrapper">

    <header>
      <h1>Registro de Cartones</h1>
      <button class="volver-btn" onclick="window.location.href='index.html'">Volver</button>
    </header>

    <div class="button-bar">
      <button id="btnGestion" class="gestion-btn">Gestionar Cartones</button>
      <button id="btnCopiar" class="copiar-btn">Copiar Tablas</button>
      <button id="btnBorrar" class="borrar-btn">Borrar todos los registros</button>
    </div>

    <div class="resumen" id="resumen">
        </div>

    <table id="tablaCartones">
      <caption>Cartón - Nombre</caption>
      <thead><tr><th>Cartón</th><th>Nombre</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Apartados y Pagos Pendientes</h2>
    <table id="tablaApartados">
      <caption>Monto - Referencia - Nombre - Números comprados</caption>
      <thead>
        <tr><th>Monto (BS)</th><th>Referencia</th><th>Nombre</th><th>Números comprados</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Registro de Pagos Confirmados (Referencia Numérica)</h2>
    <table id="tablaPagos">
      <caption>Monto - Referencia - Nombre - Números comprados</caption>
      <thead>
        <tr><th>Monto (BS)</th><th>Referencia</th><th>Nombre</th><th>Números comprados</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>


    <div id="gestionPanel">
      <h2>Gestión de Cartones Vendidos</h2>
      <table id="gestionTabla">
        <thead><tr><th>Cartón</th><th>Nombre</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

</div> 
</body>
</html>
