<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registro de Compras (0.2 - Moderno)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

<style>
  * {
      box-sizing: border-box;
  }
  
  body { 
      background: linear-gradient(135deg, #0b021a 0%, #121212 100%); 
      color: #f0f0f0; 
      font-family: 'Nunito', Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      min-height: 100vh;
  }

  .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
  }

  header { 
      display: flex; 
      justify-content: space-between; /* Alinea el título a la izq. y el botón a la der. */
      align-items: center; 
      gap: 20px; 
      margin-bottom: 30px; 
      border-bottom: 1px solid #333;
      padding-bottom: 20px;
  }
  
  h1, h2 { 
      margin: 0; 
      color: #ffffff;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
  }

  h2 {
      margin-top: 40px; /* Espacio antes del título de la segunda tabla */
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.8em;
  }

  /* --- Barra de Botones Principal --- */
  .button-bar {
      display: flex;
      flex-wrap: wrap; /* Para que se ajusten en móviles */
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
  }
  
  /* --- Estilo de Botones Moderno --- */
  button.volver-btn, button.borrar-btn, button.gestion-btn, button.copiar-btn {
      border: none; 
      color: white; 
      font-weight: bold;
      padding: 10px 20px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 1em;
      font-family: 'Nunito', Arial, sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }
  
  button.volver-btn, button.gestion-btn {
      background-color: #37474F; /* Gris azulado (como los cartones) */
  }
  button.volver-btn:hover, button.gestion-btn:hover { 
      background-color: #546E7A;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }
  
  button.copiar-btn {
      background: linear-gradient(45deg, #fdd835, #fbc02d); /* Dorado (como comprar) */
      color: #121212;
  }
  button.copiar-btn:hover {
      background: linear-gradient(45deg, #fbc02d, #f9a825);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(253, 216, 53, 0.3);
  }

  button.borrar-btn { 
      background-color: #e53935; /* Rojo más moderno */
  }
  button.borrar-btn:hover { 
      background-color: #c62828;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229, 57, 53, 0.3);
  }
  
  /* --- Panel de Resumen --- */
  .resumen { 
      text-align: center; 
      margin-bottom: 40px; 
      font-size: 1.1em;
      background: #1e1e1e; /* Fondo de "tarjeta" */
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #333;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px 25px; /* Espacio vertical y horizontal */
  }
  .resumen span { 
      display: inline-block; 
      margin: 0;
  }
  .resumen b {
      color: #fdd835; /* Resaltar números en dorado */
  }

  /* --- Estilo de Tablas Moderno --- */
  table { 
      width: 100%; 
      border-collapse: separate; /* Permite border-radius */
      border-spacing: 0;
      margin-bottom: 40px; 
      background: #1e1e1e;
      border-radius: 12px;
      overflow: hidden; /* Clave para que el radius afecte a th */
      border: 1px solid #333;
  }
  
  caption { 
      font-weight: 700; 
      font-size: 1.3em; 
      padding: 15px; 
      background: #2a2a2a; /* Fondo de cabecera de tarjeta */
      color: #f0f0f0;
      text-align: left;
  }
  
  th, td { 
      /* Solo bordes horizontales */
      border: none;
      border-bottom: 1px solid #333; 
      padding: 12px 15px; 
      text-align: left; 
      color: #ccc;
  }
  th { 
      background: #252525; 
      color: #fff;
      font-weight: 700;
  }
  
  /* Quita el borde de la última fila */
  tbody tr:last-child td {
      border-bottom: none;
  }

  .referencia-duplicada { 
      color: #ff6b6b; /* Rojo más brillante */
      font-weight: 700; 
  }
  .referencia-duplicada::after { 
      content: '  ¡Duplicada!'; 
      font-size: 0.85em; 
  }
  
  .carton-pendiente {
      color: #fdd835; /* Dorado (como en el resumen) */
      font-weight: 700;
      margin-left: 8px;
  }

  /* --- Panel de Gestión --- */
  #gestionPanel { 
      display: none; 
      background: #1e1e1e; 
      padding: 20px; 
      border-radius: 12px; 
      max-height: 500px; 
      overflow-y: auto; 
      margin-bottom: 30px; 
      border: 1px solid #333;
  }
  #gestionPanel h2 { 
      margin-top: 0; 
      margin-bottom: 20px; 
      text-align: left;
  }
  #gestionPanel table { 
      margin-bottom: 0; 
      border: none; /* Sin doble borde */
  }
  
  /* Botones de acción en tablas */
  #gestionPanel button.edit-btn, #gestionPanel button.delete-btn,
  #tablaPagos button.edit-btn, #tablaPagos button.delete-btn {
      padding: 4px 10px; 
      margin: 2px 3px; 
      font-size: 0.9em; 
      cursor: pointer; 
      border-radius: 4px; 
      border: none;
      font-weight: 700;
      font-family: 'Nunito', Arial, sans-serif;
      transition: all 0.2s ease;
  }
  
  button.edit-btn { background: #2196f3; color: white; }
  button.edit-btn:hover { background: #0b7dda; transform: scale(1.05); }
  button.delete-btn { background: #e53935; color: white; }
  button.delete-btn:hover { background: #c62828; transform: scale(1.05); }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Tu configuración de Firebase (sin cambios)
  const firebaseConfig = {
    apiKey: "AIzaSyCJXV1uIO7k-mskXmLeTLRzH0JmBW6Bkm4",
    authDomain: "bingomagic.firebaseapp.com",
    projectId: "bingomagic",
    storageBucket: "bingomagic.firebasestorage.app",
    messagingSenderId: "239927101364",
    appId: "1:239927101364:web:7557e068b2564c63a194e1",
    measurementId: "G-0GJL6DJCEB"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Tu JavaScript de `cargarRegistros` (sin cambios)
  async function cargarRegistros() {
    const registros = {};
    let totalMonto = 0;
    const referencias = new Map();
    let totalPendientes = 0; 

    // Cargar registrosCartones
    const snapshotCartones = await db.collection('registrosCartones').get();
    snapshotCartones.forEach(doc => { registros[doc.id] = doc.data().nombre; });

    const cartonesOrdenados = Object.keys(registros).map(Number).sort((a,b) => a-b);
    const tbodyCartones = document.querySelector('#tablaCartones tbody');
    tbodyCartones.innerHTML = '';
    for (const c of cartonesOrdenados) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c}</td><td>${registros[c]}</td>`;
      tbodyCartones.appendChild(tr);
    }

    // Cargar registrosPagos
    const snapshotPagos = await db.collection('registrosPagos').orderBy('timestamp', 'desc').get();
    const tbodyPagos = document.querySelector('#tablaPagos tbody');
    tbodyPagos.innerHTML = '';

    snapshotPagos.forEach(doc => {
      const data = doc.data();
      totalMonto += parseFloat(data.monto);

      const referenciaDuplicada = referencias.has(data.referencia);
      referencias.set(data.referencia, true);
      
      const cartonesStr = (data.cartones && data.cartones.length > 0) ? data.cartones.join(", ") : "";
      const numPendientes = data.pendientes || 0;
      totalPendientes += numPendientes; 
      
      const pendienteStr = (numPendientes > 0) ? `<span class="carton-pendiente">(+${numPendientes} pendiente${numPendientes > 1 ? 's' : ''})</span>` : "";
      
      let celdaCartones = cartonesStr + pendienteStr;
      if (celdaCartones.trim() === "") { 
          celdaCartones = "-"; 
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.monto}</td>
        <td class="${referenciaDuplicada ? 'referencia-duplicada' : ''}">${data.referencia}</td>
        <td>${data.nombre || "-"}</td>
        <td>${celdaCartones}</td>
        <td>
          <button class='edit-btn' onclick='editarPago("${doc.id}", ${JSON.stringify(data.cartones || [])}, ${numPendientes})'>Editar</button>
          <button class='delete-btn' onclick='eliminarPago("${doc.id}", ${JSON.stringify(data.cartones || [])})'>Eliminar</button>
        </td>
      `;
      tbodyPagos.appendChild(tr);
    });

    document.getElementById('resumen').innerHTML = `
      <span>Cartones vendidos: <b>${cartonesOrdenados.length}</b></span>
      <span>Cartones faltantes: <b>${360 - cartonesOrdenados.length}</b></span>
      ${totalPendientes > 0 ? `<span>Pendientes por asignar: <b>${totalPendientes}</b></span>` : ''}
      <span>
        Monto vendido: <b>${totalMonto} Bs</b>
        ${totalMonto !== (cartonesOrdenados.length + totalPendientes) * 75 
          ? ' <b style="color:#ff6b6b;">⚠ Inconsistencia</b>' 
          : ''}
      </span>
    `;

    if (document.getElementById('gestionPanel').style.display === 'block') {
      cargarGestionPanel(registros, cartonesOrdenados);
    }
  }

  // Tu JavaScript de `toggleGestion` (sin cambios)
  function toggleGestion() {
    const panel = document.getElementById('gestionPanel');
    panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    if (panel.style.display === 'block') cargarRegistros();
  }

  // Tu JavaScript de `cargarGestionPanel` (sin cambios)
  function cargarGestionPanel(registros, cartonesOrdenados) {
    const tbodyGestion = document.querySelector('#gestionTabla tbody');
    tbodyGestion.innerHTML = '';
    cartonesOrdenados.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c}</td><td>${registros[c]}</td><td>
        <button class='edit-btn' onclick='editarNombre(${c})'>Editar</button>
        <button class='delete-btn' onclick='eliminarCarton(${c})'>Eliminar</button>
      </td>`;
      tbodyGestion.appendChild(tr);
    });
  }

  // Tu JavaScript de `editarNombre` (sin cambios)
  function editarNombre(carton) {
    const nuevoNombre = prompt("Editar nombre del jugador para cartón " + carton + ":");
    if (nuevoNombre && nuevoNombre.trim()) {
      db.collection('registrosCartones').doc(carton.toString()).update({ nombre: nuevoNombre.trim() })
        .then(() => cargarRegistros());
    }
  }

  // Tu JavaScript de `eliminarCarton` (sin cambios)
  function eliminarCarton(carton) {
    if (confirm("¿Deseas eliminar el cartón " + carton + " del registro?")) {
      db.collection('registrosCartones').doc(carton.toString()).delete().then(() => cargarRegistros());
    }
  }

  // Tu JavaScript de `editarPago` (sin cambios)
  async function editarPago(pagoId, cartonesActuales, pendientesActuales) {
    const nuevoTexto = prompt("Edita los cartones comprados (separados por coma):", cartonesActuales.join(", "));
    if (nuevoTexto === null) return; // Usuario canceló

    const nuevoPendienteTexto = prompt("Edita el número de cartones PENDIENTES:", pendientesActuales);
    if (nuevoPendienteTexto === null) return; // Usuario canceló

    const nuevosCartones = nuevoTexto.split(",").map(s => parseInt(s.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 360);
    const nuevosPendientes = parseInt(nuevoPendienteTexto) || 0;


    // Verificar duplicados
    const snapshot = await db.collection('registrosCartones').get();
    const vendidos = new Set();
    snapshot.forEach(doc => vendidos.add(parseInt(doc.id)));

    for (let n of nuevosCartones) {
      if (vendidos.has(n) && !cartonesActuales.includes(n)) {
        alert(`El cartón ${n} ya está vendido.`);
        return;
      }
    }

    // Obtener datos actuales del pago (para el nombre)
    const pagoDoc = await db.collection('registrosPagos').doc(pagoId).get();
    const data = pagoDoc.data();

    const batch = db.batch();

    // Eliminar cartones anteriores que ya no están en la lista
    cartonesActuales.forEach(n => {
      if (!nuevosCartones.includes(n)) {
        batch.delete(db.collection('registrosCartones').doc(n.toString()));
      }
    });

    // Agregar nuevos cartones
    nuevosCartones.forEach(n => {
      // Solo añade/actualiza si no es un cartón que ya estaba (para ahorrar escrituras)
      if (!cartonesActuales.includes(n)) {
          batch.set(db.collection('registrosCartones').doc(n.toString()), { nombre: data.nombre });
      }
    });

    // Actualizar el pago con los nuevos cartones Y los nuevos pendientes
    batch.update(db.collection('registrosPagos').doc(pagoId), { 
        cartones: nuevosCartones,
        pendientes: nuevosPendientes // Guarda el nuevo número de pendientes
    });

    await batch.commit();
    alert("Pago actualizado correctamente.");
    cargarRegistros();
  }

  // Tu JavaScript de `eliminarPago` (sin cambios)
  async function eliminarPago(pagoId, cartones) {
    if (!confirm("¿Deseas eliminar este pago y liberar los cartones?")) return;
    try {
      const batch = db.batch();
      // Eliminar cartones asociados
      cartones.forEach(n => {
        batch.delete(db.collection('registrosCartones').doc(n.toString()));
      });
      // Eliminar pago
      batch.delete(db.collection('registrosPagos').doc(pagoId));
      await batch.commit();
      alert("Pago eliminado correctamente.");
      cargarRegistros();
    } catch (error) {
      console.error("Error eliminando pago:", error);
      alert("Error al eliminar el pago.");
    }
  }

  // Tu JavaScript de `borrarRegistros` (sin cambios)
  async function borrarRegistros() {
    if (!confirm("¿Estás seguro que quieres borrar todos los registros?")) return;
    try {
      const batch = db.batch();
      const cartonesSnapshot = await db.collection('registrosCartones').get();
      cartonesSnapshot.forEach(doc => batch.delete(doc.ref));
      const pagosSnapshot = await db.collection('registrosPagos').get();
      pagosSnapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      alert("Todos los registros han sido borrados.");
      cargarRegistros();
    } catch (error) {
      console.error("Error borrando registros:", error);
      alert("Error al borrar los registros.");
    }
  }

  
  // ********** ¡FUNCIÓN DE COPIAR CORREGIDA! **********
  // (Ahora solo copia la tabla de cartones)
  function copiarTablasAlPortapapeles() {
    function tablaAtexto(tabla) {
      let texto = '';
      const filas = tabla.querySelectorAll('tr');
      filas.forEach(fila => {
        const celdas = fila.querySelectorAll('th, td');
        // Mapea celdas, pero ignora la de 'Acciones'
        const filaTexto = Array.from(celdas).map((c, idx) => {
            if (c.textContent.trim() === 'Acciones') return null; // Ignorar cabecera
            // Si la fila tiene botones Y es la última celda, ignorarla
            if (fila.querySelector('button') && idx === celdas.length - 1) return null; 
            
            return c.textContent.trim()
                     .replace(/\s+/g, ' '); // Limpia espacios extra
        })
        .filter(t => t !== null) // Filtra las celdas nulas
        .join('\t'); // Separa por tabulación
        
        if (filaTexto) texto += filaTexto + '\n';
      });
      return texto;
    }
    const tablaCartones = document.getElementById('tablaCartones');
    
    // Modificado: Solo incluye la tabla de cartones
    const textoFinal = `== Cartones Vendidos ==\n` + 
                       tablaAtexto(tablaCartones);
                       
    navigator.clipboard.writeText(textoFinal)
      // Modificado: Mensaje de alerta actualizado
      .then(() => alert('¡Tabla de Cartones Vendidos copiada al portapapeles!'))
      .catch(err => alert('Error al copiar: 'D' + err));
  }
  
  // Tu JavaScript de `DOMContentLoaded` (sin cambios)
  document.addEventListener('DOMContentLoaded', () => {
    cargarRegistros();
    document.getElementById('btnBorrar').addEventListener('click', borrarRegistros);
    document.getElementById('btnGestion').addEventListener('click', toggleGestion);
    document.getElementById('btnCopiar').addEventListener('click', copiarTablasAlPortapapeles);
  });
</script>
</head>
<body>

<div class="content-wrapper">

    <header>
      <h1>Registro de Cartones</h1>
      <button class="volver-btn" onclick="window.location.href='index.html'">Volver</button>
    </header>

    <div class="button-bar">
      <button id="btnGestion" class="gestion-btn">Gestionar Cartones</button>
      <button id="btnCopiar" class="copiar-btn">Copiar Tabla de Cartones</button> <button id="btnBorrar" class="borrar-btn">Borrar todos los registros</button>
    </div>

    <div class="resumen" id="resumen">
        </div>

    <table id="tablaCartones">
      <caption>Cartón - Nombre</caption>
      <thead><tr><th>Cartón</th><th>Nombre</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Registro de Pagos</h2>
    <table id="tablaPagos">
      <caption>Monto - Referencia - Nombre - Números comprados</caption>
      <thead>
        <tr><th>Monto (BS)</th><th>Referencia</th><th>Nombre</th><th>Números comprados</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="gestionPanel">
      <h2>Gestión de Cartones Vendidos</h2>
      <table id="gestionTabla">
        <thead><tr><th>Cartón</th><th>Nombre</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

</div> </body>
</html>
